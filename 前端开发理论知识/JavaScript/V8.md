# Macrotask/Microtask Quque

```js
setImmediate(function(){
    console.log(1);
},0);
setTimeout(function(){
    console.log(2);
},0);
new Promise(function(resolve){
    console.log(3);
    resolve();
    console.log(4);
}).then(function(){
    console.log(5);
});
console.log(6);
process.nextTick(function(){
    console.log(7);
});
console.log(8);

// 结果是：3 4 6 8 7 5 2 1
```


Event Loop 里存在两类队列，分别为 Macrotask 和 Microtask

```
macrotasks: script(整体代码),setTimeout, setInterval, setImmediate, I/O, UI rendering
microtasks: process.nextTick, Promises, Object.observe, MutationObserver
```

而且有：
```
process.nextTick > promise.then

setTimeout > setImmediate
```


执行过程如下：
- JavaScript 引擎首先从 macrotask queue 中取出第一个任务
- 执行完毕后，将 microtask queue 中的所有任务取出，按顺序全部执行（注意：当这些 microtask 执行过程中还能继续添加 microtask 到 microtask queue 里，直到 microtask queue 为空）
- 然后再从 macrotask queue 中取下一个
- 执行完毕后，再次将 microtask queue 中的全部取出
- 循环往复，直到两个 queue 中的任务都取完


Reference
- [Macrotask Queue和Microtask Quque](http://www.jianshu.com/p/3ed992529cfc)
- [45.理解事件循环二(macrotask和microtask) #48](https://github.com/ccforward/cc/issues/48)