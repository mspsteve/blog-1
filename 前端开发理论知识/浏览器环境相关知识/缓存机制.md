# 缓存机制

[前端早读课-【第1250期】彻底理解浏览器的缓存机制](https://mp.weixin.qq.com/s/d2zeGhUptGUGJpB5xHQbOA)

这篇文章介绍地比较详细

## DNS 缓存


## 浏览器本地缓存

浏览器首次访问资源时，如果服务器返回资源可以缓存，则会在响应头里添加如下头部，并将缓存文件
- `Cache-Control`：是否可缓存/缓存类型/缓存最大时长
- `Expires`：缓存失效的时间戳

浏览器再次请求该资源时，会优先在本地查找是否有缓存的资源，并根据缓存文件的这两个头部来判断是否可以使用使用该缓存资源。如果资源未过期，则直接使用该缓存资源，不需要向服务器发送请求。如果资源已经过期，则向服务器发出条件请求，询问服务器该资源是否修改过（详情见下一节）。

注意：如果同时有`Expires`头部和`Cache-Control`头部，且其`Cache-Control`的值有`max-age`/`s-maxage`，则`Expires`头部将被忽略。


## 条件请求 & 304

当浏览器缓存了目标资源，但是不确定该缓存资源是否是最新版本的时候，就会发送条件请求。

请求头里主要有两个头部需要关注：
- `If-Modified-Since`：其值为缓存资源上次请求返回时，响应头里的`Last-Modified`字段的值
- `If-None-Match`：其值为缓存资源上次请求返回时，响应头里的`ETag`字段的值

服务器接到这个请求之后，判断出浏览器缓存的资源是否是最新的。
- 如果资源未过期，则返回 HTTP/304 NOT Modified 响应，该响应没有响应体，浏览器收到 304 响应后，就会从缓存中读取对应的资源，并更新缓存文件的`Expires`头部
- 否则，服务器返回 HTTP/200 OK 响应，响应体为该资源当前最新的内容，浏览器接收到新的响应体后将覆盖旧的缓存资源

注意：只有浏览器缓存了要请求的资源且缓存资源的响应头中包含了`Last-Modified`头部或`ETag`头部，才可能发送条件请求。如果这两个头部都不存在，则浏览器会正常请求资源，服务器也就必须返回完整的资源数据。


## CDN 缓存